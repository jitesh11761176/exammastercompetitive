generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String               @id @default(cuid())
  name                 String?
  email                String               @unique
  emailVerified        DateTime?
  image                String?
  role                 Role                 @default(STUDENT)
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  accounts             Account[]
  analytics            Analytics?
  bookmarks            Bookmark[]
  chatSessions         ChatSession[]
  courseEnrollments    CourseEnrollment[]
  courseReviews        CourseReview[]
  gamification         Gamification?
  notifications        Notification[]
  purchases            Purchase[]
  pushSubscriptions    PushSubscription[]
  reports              QuestionReport[]
  sessions             Session[]
  studyPlans           StudyPlan[]
  studySessions        StudySession[]
  subscriptions        Subscription[]
  testAttempts         TestAttempt[]
  userBadges           UserBadge[]
  interestedCategories UserCategory[]
  interactions         UserInteraction[]
  userProgress         UserProgress[]
  recommendations      UserRecommendation[]

  @@index([email])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Category {
  id              String         @id @default(cuid())
  courseId        String
  name            String
  slug            String
  description     String?
  icon            String?
  order           Int            @default(0)
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  course          Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  subjects        Subject[]
  tests           Test[]
  interestedUsers UserCategory[]

  @@unique([courseId, slug])
  @@index([courseId])
  @@index([slug])
  @@index([isActive])
  @@map("categories")
}

model Subject {
  id          String   @id @default(cuid())
  categoryId  String
  name        String
  slug        String
  description String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  topics      Topic[]

  @@unique([categoryId, slug])
  @@index([categoryId])
  @@map("subjects")
}

model Topic {
  id          String     @id @default(cuid())
  subjectId   String
  name        String
  slug        String
  description String?
  weightage   Float      @default(0)
  difficulty  Difficulty @default(MEDIUM)
  order       Int        @default(0)
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  questions   Question[]
  subject     Subject    @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([subjectId, slug])
  @@index([subjectId])
  @@map("topics")
}

model Question {
  id                  String           @id @default(cuid())
  topicId             String
  questionType        QuestionType     @default(MCQ)
  questionText        String
  questionImage       String?
  mathContent         String?
  optionA             String?
  optionB             String?
  optionC             String?
  optionD             String?
  optionE             String?
  optionF             String?
  correctOption       String?
  correctOptions      String[]
  integerAnswer       Int?
  rangeMin            Float?
  rangeMax            Float?
  explanation         String
  solutionSteps       Json?
  explanationVideoUrl String?
  mathSolution        String?
  difficulty          Difficulty       @default(MEDIUM)
  marks               Float            @default(1.0)
  negativeMarks       Float            @default(0.25)
  partialMarking      Boolean          @default(false)
  partialMarkingRules Json?
  timeToSolve         Int              @default(60)
  yearAsked           Int?
  examName            String?
  timesAttempted      Int              @default(0)
  timesCorrect        Int              @default(0)
  timesPartialCorrect Int              @default(0)
  averageTimeTaken    Int              @default(0)
  successRate         Float            @default(0)
  tags                String[]
  createdBy           String?
  verifiedBy          String?
  isVerified          Boolean          @default(false)
  moderationStatus    ModerationStatus @default(PENDING)
  moderationNotes     String?
  version             Int              @default(1)
  parentQuestionId    String?
  isActive            Boolean          @default(true)
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  publishedAt         DateTime?
  bookmarks           Bookmark[]
  reports             QuestionReport[]
  parentQuestion      Question?        @relation("QuestionVersions", fields: [parentQuestionId], references: [id])
  questionVersions    Question[]       @relation("QuestionVersions")
  topic               Topic            @relation(fields: [topicId], references: [id], onDelete: Cascade)
  userProgress        UserProgress[]

  @@index([topicId])
  @@index([difficulty])
  @@index([isActive])
  @@index([questionType])
  @@index([moderationStatus])
  @@index([createdBy])
  @@map("questions")
}

model Test {
  id                      String           @id @default(cuid())
  title                   String
  description             String?
  categoryId              String
  testType                TestType         @default(FULL_LENGTH)
  pyqYear                 Int?
  order                   Int              @default(0)
  duration                Int
  sectionDurations        Json?
  totalQuestions          Int
  totalMarks              Float
  passingMarks            Float
  questionIds             String[]
  sections                Json?
  instructions            String?
  hasNegativeMarking      Boolean          @default(true)
  negativeMarkingRules    Json?
  allowReview             Boolean          @default(true)
  allowReattempt          Boolean          @default(true)
  maxAttempts             Int              @default(3)
  showSolutions           Boolean          @default(true)
  solutionsAvailableAfter DateTime?
  shuffleQuestions        Boolean          @default(false)
  shuffleOptions          Boolean          @default(false)
  isFree                  Boolean          @default(false)
  isPremium               Boolean          @default(false)
  isActive                Boolean          @default(true)
  difficulty              Difficulty       @default(MEDIUM)
  tags                    String[]
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt
  publishedAt             DateTime?
  challengeTests          DailyChallenge[]
  attempts                TestAttempt[]
  category                Category         @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
  @@index([isActive])
  @@index([testType])
  @@index([isFree])
  @@index([isPremium])
  @@index([difficulty])
  @@map("tests")
}

model TestAttempt {
  id               String        @id @default(cuid())
  userId           String
  testId           String
  attemptNumber    Int           @default(1)
  startTime        DateTime
  endTime          DateTime?
  timeTaken        Int?
  sectionTimings   Json?
  answers          Json
  markedForReview  String[]
  visitedQuestions String[]
  score            Float         @default(0)
  totalMarks       Float
  accuracy         Float         @default(0)
  correctAnswers   Int           @default(0)
  wrongAnswers     Int           @default(0)
  partialCorrect   Int           @default(0)
  unattempted      Int           @default(0)
  sectionScores    Json?
  rank             Int?
  percentile       Float?
  detailedReport   Json?
  weakTopics       String[]
  strongTopics     String[]
  solutionsViewed  Boolean       @default(false)
  status           AttemptStatus @default(IN_PROGRESS)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  test             Test          @relation(fields: [testId], references: [id], onDelete: Cascade)
  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([testId])
  @@index([status])
  @@index([createdAt])
  @@map("test_attempts")
}

model CourseEnrollment {
  id             String           @id @default(cuid())
  userId         String
  courseId       String
  status         EnrollmentStatus @default(ACTIVE)
  enrolledAt     DateTime         @default(now())
  lastAccessedAt DateTime?
  completedTests Int              @default(0)
  totalScore     Float            @default(0)
  averageScore   Float            @default(0)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  course         Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@index([status])
  @@map("course_enrollments")
}

model Course {
  id          String             @id @default(cuid())
  title       String
  slug        String             @unique
  description String?
  thumbnail   String?
  icon        String?
  tags        String[]
  order       Int                @default(0)
  isActive    Boolean            @default(true)
  isFree      Boolean            @default(false)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  categories  Category[]
  enrollments CourseEnrollment[]
  reviews     CourseReview[]

  @@index([slug])
  @@index([isActive])
  @@map("courses")
}

model CourseReview {
  id          String   @id @default(cuid())
  userId      String
  courseId    String
  rating      Int
  comment     String?
  isVerified  Boolean  @default(false)
  isPublished Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId])
  @@index([rating])
  @@map("course_reviews")
}

model Purchase {
  id                String        @id @default(cuid())
  userId            String
  itemType          PurchaseType
  itemId            String
  itemTitle         String
  amount            Float
  currency          String        @default("INR")
  razorpayOrderId   String?       @unique
  razorpayPaymentId String?       @unique
  razorpaySignature String?
  status            PaymentStatus @default(PENDING)
  metadata          Json?
  failureReason     String?
  receiptUrl        String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  paidAt            DateTime?
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([itemType, itemId])
  @@index([createdAt])
  @@map("purchases")
}

model UserProgress {
  id               String   @id @default(cuid())
  userId           String
  questionId       String
  attemptNumber    Int      @default(1)
  isCorrect        Boolean
  isPartialCorrect Boolean  @default(false)
  selectedOption   String?
  selectedOptions  String[]
  integerAnswer    Int?
  timeTaken        Int
  hintsUsed        Int      @default(0)
  solutionViewed   Boolean  @default(false)
  attemptedAt      DateTime @default(now())
  question         Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, questionId])
  @@index([userId])
  @@index([questionId])
  @@index([isCorrect])
  @@index([attemptedAt])
  @@map("user_progress")
}

model Analytics {
  id                      String    @id @default(cuid())
  userId                  String    @unique
  totalTestsAttempted     Int       @default(0)
  totalQuestionsAttempted Int       @default(0)
  totalCorrect            Int       @default(0)
  totalWrong              Int       @default(0)
  totalPartialCorrect     Int       @default(0)
  overallAccuracy         Float     @default(0)
  totalTimeSpent          Int       @default(0)
  averageSpeed            Float     @default(0)
  currentStreak           Int       @default(0)
  longestStreak           Int       @default(0)
  lastActivityDate        DateTime?
  strongTopics            String[]
  weakTopics              String[]
  topicWiseAccuracy       Json?
  subjectWiseAccuracy     Json?
  preferredStudyTime      String?
  peakPerformanceHour     Int?
  averageSessionDuration  Int       @default(0)
  totalSessions           Int       @default(0)
  cohortMonth             String?
  retentionDay1           Boolean   @default(false)
  retentionDay7           Boolean   @default(false)
  retentionDay30          Boolean   @default(false)
  daysSinceSignup         Int       @default(0)
  accuracyTrend           Json?
  speedTrend              Json?
  timeTrend               Json?
  updatedAt               DateTime  @updatedAt
  user                    User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([cohortMonth])
  @@map("analytics")
}

model StudyPlan {
  id                   String         @id @default(cuid())
  userId               String
  planName             String
  targetExam           String
  examDate             DateTime?
  dailyTargetQuestions Int            @default(50)
  dailyTargetMinutes   Int            @default(120)
  dailyTargetTopics    Int            @default(3)
  weeklyTargetTests    Int            @default(3)
  weeklyTargetChapters Int            @default(5)
  topicsToCover        Json
  weeklySchedule       Json
  milestones           Json?
  completionPercentage Float          @default(0)
  questionsCompleted   Int            @default(0)
  testsCompleted       Int            @default(0)
  currentStreak        Int            @default(0)
  reminderTime         String?
  reminderDays         String[]
  emailReminders       Boolean        @default(true)
  pushNotifications    Boolean        @default(true)
  isActive             Boolean        @default(true)
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  goals                StudyGoal[]
  user                 User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessions             StudySession[]

  @@index([userId])
  @@index([isActive])
  @@map("study_plans")
}

model StudyGoal {
  id           String    @id @default(cuid())
  studyPlanId  String
  goalType     GoalType
  title        String
  description  String?
  targetValue  Int
  currentValue Int       @default(0)
  deadline     DateTime?
  isCompleted  Boolean   @default(false)
  completedAt  DateTime?
  createdAt    DateTime  @default(now())
  studyPlan    StudyPlan @relation(fields: [studyPlanId], references: [id], onDelete: Cascade)

  @@index([studyPlanId])
  @@index([isCompleted])
  @@map("study_goals")
}

model StudySession {
  id                 String     @id @default(cuid())
  userId             String
  studyPlanId        String?
  startTime          DateTime
  endTime            DateTime?
  duration           Int?
  questionsAttempted Int        @default(0)
  questionsCorrect   Int        @default(0)
  topicsCovered      String[]
  notes              String?
  createdAt          DateTime   @default(now())
  studyPlan          StudyPlan? @relation(fields: [studyPlanId], references: [id])
  user               User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([studyPlanId])
  @@index([startTime])
  @@map("study_sessions")
}

model Gamification {
  id               String    @id @default(cuid())
  userId           String    @unique
  totalPoints      Int       @default(0)
  currentLevel     Int       @default(1)
  experiencePoints Int       @default(0)
  dailyStreak      Int       @default(0)
  weeklyRank       Int?
  monthlyRank      Int?
  allTimeRank      Int?
  lastPointEarned  DateTime?
  updatedAt        DateTime  @updatedAt
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([totalPoints])
  @@map("gamification")
}

model Badge {
  id          String      @id @default(cuid())
  name        String
  description String
  icon        String
  rarity      BadgeRarity @default(COMMON)
  points      Int         @default(0)
  criteria    Json
  createdAt   DateTime    @default(now())
  userBadges  UserBadge[]

  @@map("badges")
}

model UserBadge {
  id          String   @id @default(cuid())
  userId      String
  badgeId     String
  unlockedAt  DateTime @default(now())
  isDisplayed Boolean  @default(false)
  badge       Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
  @@map("user_badges")
}

model Leaderboard {
  id          String            @id @default(cuid())
  userId      String
  categoryId  String?
  period      LeaderboardPeriod
  score       Float
  rank        Int
  testsTaken  Int
  accuracy    Float
  periodStart DateTime
  periodEnd   DateTime
  updatedAt   DateTime          @updatedAt

  @@unique([userId, period, periodStart])
  @@index([period, rank])
  @@map("leaderboard")
}

model Bookmark {
  id         String   @id @default(cuid())
  userId     String
  questionId String
  notes      String?
  createdAt  DateTime @default(now())
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, questionId])
  @@index([userId])
  @@map("bookmarks")
}

model QuestionReport {
  id                  String       @id @default(cuid())
  questionId          String
  reportedBy          String
  reportType          ReportType
  description         String
  suggestedCorrection String?
  status              ReportStatus @default(PENDING)
  rewardGiven         Int          @default(0)
  reviewedBy          String?
  reviewedAt          DateTime?
  createdAt           DateTime     @default(now())
  question            Question     @relation(fields: [questionId], references: [id], onDelete: Cascade)
  reporter            User         @relation(fields: [reportedBy], references: [id], onDelete: Cascade)

  @@index([questionId])
  @@index([status])
  @@map("question_reports")
}

model UserCategory {
  id         String   @id @default(cuid())
  userId     String
  categoryId String
  createdAt  DateTime @default(now())
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId])
  @@index([userId])
  @@index([categoryId])
  @@map("user_categories")
}

model ChatSession {
  id         String        @id @default(cuid())
  userId     String
  title      String        @default("New Chat")
  questionId String?
  context    String?
  isActive   Boolean       @default(true)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  messages   ChatMessage[]
  user       User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([questionId])
  @@map("chat_sessions")
}

model ChatMessage {
  id         String      @id @default(cuid())
  sessionId  String
  role       MessageRole
  content    String
  model      String?
  tokens     Int?
  ragSources Json?
  confidence Float?
  createdAt  DateTime    @default(now())
  session    ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
  @@map("chat_messages")
}

model AIHint {
  id             String   @id @default(cuid())
  questionId     String
  hintLevel      Int
  hintText       String
  affectsScore   Boolean  @default(true)
  scoreReduction Float    @default(0.1)
  aiGenerated    Boolean  @default(false)
  createdAt      DateTime @default(now())

  @@index([questionId])
  @@map("ai_hints")
}

model AIGeneratedQuestion {
  id                 String                   @id @default(cuid())
  sourceQuestionId   String?
  prompt             String
  generatedData      Json
  aiModel            String
  status             QuestionGenerationStatus @default(PENDING_REVIEW)
  reviewedBy         String?
  approvedQuestionId String?
  createdAt          DateTime                 @default(now())
  reviewedAt         DateTime?

  @@index([status])
  @@index([createdAt])
  @@map("ai_generated_questions")
}

model SubjectiveEvaluation {
  id             String           @id @default(cuid())
  attemptId      String
  questionId     String
  userAnswer     String
  aiScore        Float?
  aiRubric       Json?
  aiFeedback     String?
  aiModel        String?
  manualScore    Float?
  manualFeedback String?
  evaluatedBy    String?
  finalScore     Float?
  status         EvaluationStatus @default(PENDING)
  createdAt      DateTime         @default(now())
  evaluatedAt    DateTime?

  @@index([attemptId])
  @@index([status])
  @@map("subjective_evaluations")
}

model DocumentUpload {
  id                 String           @id @default(cuid())
  uploadedBy         String
  fileName           String
  fileUrl            String
  fileType           String
  uploadType         UploadType
  extractedText      String?
  aiProcessingStatus ProcessingStatus @default(PENDING)
  aiModel            String?
  extractedQuestions Json?
  errorMessage       String?
  examName           String?
  year               Int?
  categoryId         String?
  subjectId          String?
  processedAt        DateTime?
  createdAt          DateTime         @default(now())

  @@index([uploadedBy])
  @@index([aiProcessingStatus])
  @@index([uploadType])
  @@map("document_uploads")
}

model UserRecommendation {
  id                 String             @id @default(cuid())
  userId             String
  recommendationType RecommendationType
  itemId             String
  itemType           String
  score              Float
  reason             String?
  nextReviewDate     DateTime?
  reviewCount        Int                @default(0)
  easeFactor         Float              @default(2.5)
  interval           Int                @default(1)
  isViewed           Boolean            @default(false)
  isCompleted        Boolean            @default(false)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([recommendationType])
  @@index([nextReviewDate])
  @@map("user_recommendations")
}

model UserInteraction {
  id              String          @id @default(cuid())
  userId          String
  itemId          String
  itemType        String
  interactionType InteractionType
  timeSpent       Int?
  completed       Boolean         @default(false)
  score           Float?
  metadata        Json?
  createdAt       DateTime        @default(now())
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([itemType, itemId])
  @@index([createdAt])
  @@map("user_interactions")
}

model SearchIndex {
  id           String   @id @default(cuid())
  documentId   String   @unique
  documentType String
  title        String
  content      String
  tags         String[]
  categoryName String?
  subjectName  String?
  topicName    String?
  difficulty   String?
  examName     String?
  year         Int?
  isPremium    Boolean  @default(false)
  searchVector String?
  popularity   Int      @default(0)
  updatedAt    DateTime @updatedAt
  createdAt    DateTime @default(now())

  @@index([documentType])
  @@index([difficulty])
  @@index([isPremium])
  @@map("search_index")
}

model PushSubscription {
  id         String   @id @default(cuid())
  userId     String
  endpoint   String   @unique
  p256dh     String
  auth       String
  deviceInfo Json?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
  @@map("push_subscriptions")
}

model OfflineQueue {
  id          String      @id @default(cuid())
  userId      String
  action      String
  payload     Json
  status      QueueStatus @default(PENDING)
  attempts    Int         @default(0)
  lastAttempt DateTime?
  createdAt   DateTime    @default(now())

  @@index([userId])
  @@index([status])
  @@map("offline_queue")
}

model Notification {
  id           String           @id @default(cuid())
  userId       String
  type         NotificationType
  title        String
  message      String
  actionUrl    String?
  isRead       Boolean          @default(false)
  isSent       Boolean          @default(false)
  sentAt       DateTime?
  readAt       DateTime?
  scheduledFor DateTime?
  createdAt    DateTime         @default(now())
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([scheduledFor])
  @@map("notifications")
}

model Subscription {
  id                     String             @id @default(cuid())
  userId                 String
  plan                   SubscriptionPlan
  status                 SubscriptionStatus @default(ACTIVE)
  stripeCustomerId       String?
  stripeSubscriptionId   String?
  razorpayCustomerId     String?
  razorpaySubscriptionId String?
  amount                 Float
  currency               String             @default("USD")
  billingCycle           BillingCycle       @default(MONTHLY)
  startDate              DateTime           @default(now())
  endDate                DateTime
  trialEndsAt            DateTime?
  canceledAt             DateTime?
  testsLimit             Int                @default(-1)
  testsUsed              Int                @default(0)
  questionsLimit         Int                @default(-1)
  questionsUsed          Int                @default(0)
  autoRenew              Boolean            @default(true)
  nextBillingDate        DateTime?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  payments               Payment[]
  user                   User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([endDate])
  @@map("subscriptions")
}

model Payment {
  id                String        @id @default(cuid())
  userId            String
  subscriptionId    String?
  amount            Float
  currency          String        @default("USD")
  paymentMethod     PaymentMethod
  status            PaymentStatus @default(PENDING)
  stripePaymentId   String?
  razorpayPaymentId String?
  razorpayOrderId   String?
  description       String?
  metadata          Json?
  failureReason     String?
  receiptUrl        String?
  paidAt            DateTime?
  createdAt         DateTime      @default(now())
  subscription      Subscription? @relation(fields: [subscriptionId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

model Coupon {
  id              String             @id @default(cuid())
  code            String             @unique
  description     String?
  discountType    DiscountType
  discountValue   Float
  maxUses         Int?
  usedCount       Int                @default(0)
  maxUsesPerUser  Int                @default(1)
  validFrom       DateTime           @default(now())
  validUntil      DateTime?
  applicablePlans String[]
  minimumAmount   Float?
  isActive        Boolean            @default(true)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  redemptions     CouponRedemption[]

  @@index([code])
  @@index([isActive])
  @@map("coupons")
}

model CouponRedemption {
  id             String   @id @default(cuid())
  couponId       String
  userId         String
  discountAmount Float
  redeemedAt     DateTime @default(now())
  coupon         Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)

  @@index([couponId])
  @@index([userId])
  @@map("coupon_redemptions")
}

model DailyChallenge {
  id                String             @id @default(cuid())
  date              DateTime           @unique
  testId            String?
  questionIds       String[]
  title             String
  description       String?
  basePoints        Int                @default(50)
  bonusPoints       Int                @default(20)
  badgeId           String?
  difficulty        Difficulty         @default(MEDIUM)
  participantsCount Int                @default(0)
  averageScore      Float              @default(0)
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  attempts          ChallengeAttempt[]
  test              Test?              @relation(fields: [testId], references: [id])

  @@index([date])
  @@index([isActive])
  @@map("daily_challenges")
}

model ChallengeAttempt {
  id            String         @id @default(cuid())
  challengeId   String
  userId        String
  score         Float
  timeTaken     Int
  rank          Int?
  pointsEarned  Int            @default(0)
  bonusEarned   Boolean        @default(false)
  badgeUnlocked Boolean        @default(false)
  completedAt   DateTime       @default(now())
  challenge     DailyChallenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@unique([challengeId, userId])
  @@index([challengeId])
  @@index([userId])
  @@map("challenge_attempts")
}

model AuditLog {
  id           String      @id @default(cuid())
  userId       String?
  userEmail    String?
  userRole     Role?
  ipAddress    String?
  userAgent    String?
  action       AuditAction
  resource     String
  resourceId   String?
  changes      Json?
  metadata     Json?
  status       AuditStatus @default(SUCCESS)
  errorMessage String?
  duration     Int?
  createdAt    DateTime    @default(now())

  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@index([resource, resourceId])
  @@index([createdAt])
  @@map("audit_logs")
}

model ErrorLog {
  id          String        @id @default(cuid())
  message     String
  stack       String?
  code        String?
  severity    ErrorSeverity @default(ERROR)
  userId      String?
  path        String?
  method      String?
  query       Json?
  body        Json?
  headers     Json?
  environment String?
  version     String?
  userAgent   String?
  ipAddress   String?
  metadata    Json?
  resolved    Boolean       @default(false)
  resolvedAt  DateTime?
  resolvedBy  String?
  createdAt   DateTime      @default(now())

  @@index([severity, createdAt])
  @@index([userId, createdAt])
  @@index([resolved, createdAt])
  @@map("error_logs")
}

model SystemMetric {
  id        String   @id @default(cuid())
  name      String
  value     Float
  unit      String?
  tags      Json?
  timestamp DateTime @default(now())

  @@index([name, timestamp])
  @@index([timestamp])
  @@map("system_metrics")
}

model Job {
  id           String    @id @default(cuid())
  name         String
  type         JobType
  queue        String    @default("default")
  data         Json
  result       Json?
  status       JobStatus @default(PENDING)
  progress     Int       @default(0)
  priority     Int       @default(0)
  attempts     Int       @default(0)
  maxAttempts  Int       @default(3)
  scheduledFor DateTime?
  startedAt    DateTime?
  completedAt  DateTime?
  failedAt     DateTime?
  error        String?
  stackTrace   String?
  createdBy    String?
  metadata     Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([status, scheduledFor])
  @@index([queue, status])
  @@index([type, status])
  @@index([createdAt])
  @@map("jobs")
}

model RateLimitLog {
  id             String    @id @default(cuid())
  identifier     String
  identifierType String
  endpoint       String
  method         String
  limit          Int
  windowMs       Int
  hits           Int       @default(1)
  windowStart    DateTime
  windowEnd      DateTime
  blocked        Boolean   @default(false)
  blockedUntil   DateTime?
  createdAt      DateTime  @default(now())

  @@index([identifier, endpoint, windowStart])
  @@index([windowEnd])
  @@map("rate_limit_logs")
}

model ApiKey {
  id             String    @id @default(cuid())
  key            String    @unique
  name           String
  description    String?
  userId         String?
  organizationId String?
  scopes         String[]
  permissions    Json?
  lastUsedAt     DateTime?
  usageCount     Int       @default(0)
  rateLimit      Int?
  isActive       Boolean   @default(true)
  expiresAt      DateTime?
  revokedAt      DateTime?
  revokedBy      String?
  revokedReason  String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([key])
  @@index([userId])
  @@index([isActive, expiresAt])
  @@map("api_keys")
}

model SecurityEvent {
  id          String            @id @default(cuid())
  type        SecurityEventType
  severity    SecuritySeverity
  userId      String?
  ipAddress   String
  userAgent   String?
  country     String?
  city        String?
  description String
  metadata    Json?
  resolved    Boolean           @default(false)
  resolvedAt  DateTime?
  resolvedBy  String?
  resolution  String?
  createdAt   DateTime          @default(now())

  @@index([type, createdAt])
  @@index([userId, createdAt])
  @@index([ipAddress, createdAt])
  @@index([resolved])
  @@map("security_events")
}

model CacheEntry {
  id             String    @id @default(cuid())
  key            String    @unique
  value          Json
  expiresAt      DateTime?
  tags           String[]
  hitCount       Int       @default(0)
  lastAccessedAt DateTime  @default(now())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([expiresAt])
  @@index([tags])
  @@map("cache_entries")
}

model Event {
  id          String    @id @default(cuid())
  name        String
  type        EventType
  data        Json
  source      String?
  userId      String?
  processed   Boolean   @default(false)
  processedAt DateTime?
  retries     Int       @default(0)
  maxRetries  Int       @default(3)
  createdAt   DateTime  @default(now())

  @@index([processed, createdAt])
  @@index([type, processed])
  @@map("events")
}

model Webhook {
  id           String      @id @default(cuid())
  url          String
  secret       String
  description  String?
  events       EventType[]
  isActive     Boolean     @default(true)
  successCount Int         @default(0)
  failureCount Int         @default(0)
  lastSuccess  DateTime?
  lastFailure  DateTime?
  lastError    String?
  userId       String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([isActive])
  @@map("webhooks")
}

model WebhookDelivery {
  id           String         @id @default(cuid())
  webhookId    String
  eventId      String
  url          String
  method       String         @default("POST")
  headers      Json?
  payload      Json
  statusCode   Int?
  responseBody String?
  responseTime Int?
  status       DeliveryStatus @default(PENDING)
  attempts     Int            @default(0)
  error        String?
  createdAt    DateTime       @default(now())
  deliveredAt  DateTime?

  @@index([webhookId, status])
  @@index([eventId])
  @@map("webhook_deliveries")
}

model PlatformSettings {
  id             String   @id @default(cuid())
  geminiApiKey   String?
  stripeApiKey   String?
  razorpayApiKey String?
  category       String   @unique
  settings       Json
  updatedBy      String?
  updatedAt      DateTime @updatedAt
  createdAt      DateTime @default(now())

  @@index([category])
  @@map("platform_settings")
}

enum Role {
  STUDENT
  INSTRUCTOR
  ADMIN
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum QuestionType {
  MCQ
  MSQ
  INTEGER
  RANGE
  SUBJECTIVE
  TRUE_FALSE
  MATCH_COLUMN
}

enum ModerationStatus {
  PENDING
  APPROVED
  REJECTED
  NEEDS_REVISION
}

enum TestType {
  FULL_LENGTH
  SECTIONAL
  TOPIC_WISE
  PREVIOUS_YEAR
  CUSTOM
  DAILY_CHALLENGE
  SPEED_TEST
}

enum AttemptStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
  UNDER_REVIEW
}

enum EnrollmentStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  SUSPENDED
}

enum PurchaseType {
  TEST_SERIES
  COURSE
  PYQ_COLLECTION
  SUBSCRIPTION
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
}

enum GoalType {
  QUESTIONS_COUNT
  TESTS_COUNT
  ACCURACY_TARGET
  TOPIC_COMPLETION
  TIME_SPENT
  STREAK_DAYS
}

enum BadgeRarity {
  COMMON
  RARE
  EPIC
  LEGENDARY
}

enum LeaderboardPeriod {
  DAILY
  WEEKLY
  MONTHLY
  ALL_TIME
}

enum ReportType {
  WRONG_ANSWER
  WRONG_QUESTION
  UNCLEAR
  DUPLICATE
  OTHER
}

enum ReportStatus {
  PENDING
  REVIEWED
  APPROVED
  REJECTED
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum QuestionGenerationStatus {
  PENDING_REVIEW
  APPROVED
  REJECTED
  NEEDS_REVISION
}

enum EvaluationStatus {
  PENDING
  AI_EVALUATED
  MANUALLY_REVIEWED
  FINALIZED
}

enum UploadType {
  QUESTION_PAPER
  SOLUTION_SHEET
  STUDY_MATERIAL
  OTHER
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum RecommendationType {
  NEXT_BEST_TEST
  WEAK_TOPIC_PRACTICE
  SPACED_REPETITION
  SIMILAR_STUDENTS
  TRENDING
  PREREQUISITE
}

enum InteractionType {
  VIEW
  START
  COMPLETE
  BOOKMARK
  SHARE
  SKIP
  HINT_USED
}

enum QueueStatus {
  PENDING
  SYNCED
  FAILED
}

enum NotificationType {
  TEST_REMINDER
  CHALLENGE_AVAILABLE
  STREAK_MILESTONE
  ACHIEVEMENT_UNLOCKED
  SUBSCRIPTION_EXPIRING
  NEW_CONTENT
  STUDY_REMINDER
  PERFORMANCE_INSIGHT
}

enum SubscriptionPlan {
  FREE
  BASIC
  PREMIUM
  ULTIMATE
}

enum SubscriptionStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELED
  EXPIRED
}

enum BillingCycle {
  MONTHLY
  QUARTERLY
  YEARLY
  LIFETIME
}

enum PaymentMethod {
  STRIPE
  RAZORPAY
  PAYPAL
  CREDIT_CARD
  UPI
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum AuditAction {
  USER_LOGIN
  USER_LOGOUT
  USER_REGISTER
  USER_UPDATE
  USER_DELETE
  QUESTION_CREATE
  QUESTION_UPDATE
  QUESTION_DELETE
  QUESTION_APPROVE
  QUESTION_REJECT
  TEST_CREATE
  TEST_UPDATE
  TEST_DELETE
  TEST_PUBLISH
  TEST_START
  TEST_SUBMIT
  TEST_REVIEW
  PAYMENT_INITIATED
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  SUBSCRIPTION_CREATED
  SUBSCRIPTION_CANCELLED
  BULK_IMPORT
  BULK_EXPORT
  SETTINGS_UPDATE
  ROLE_CHANGE
  PASSWORD_RESET
  EMAIL_VERIFIED
  SUSPICIOUS_ACTIVITY
  RATE_LIMIT_HIT
  AI_CHAT
  AI_HINT_USED
  AI_QUESTION_GENERATED
}

enum AuditStatus {
  SUCCESS
  FAILURE
  PENDING
  CANCELLED
}

enum ErrorSeverity {
  DEBUG
  INFO
  WARNING
  ERROR
  CRITICAL
}

enum JobType {
  SCORE_TEST
  GENERATE_ANALYTICS
  GENERATE_RANK
  EXPORT_PDF
  EXPORT_CSV
  EXPORT_REPORT
  SEND_EMAIL
  SEND_BULK_EMAIL
  SEND_REMINDER
  INDEX_QUESTION
  INDEX_TEST
  REINDEX_ALL
  AI_GENERATE_QUESTIONS
  AI_EVALUATE_SUBJECTIVE
  AI_EXTRACT_DOCUMENT
  CLEANUP_OLD_DATA
  CLEANUP_TEMP_FILES
  PURGE_LOGS
  SEND_PUSH_NOTIFICATION
  SEND_CHALLENGE_REMINDER
  PROCESS_REFUND
  SYNC_SUBSCRIPTION
}

enum JobStatus {
  PENDING
  ACTIVE
  COMPLETED
  FAILED
  DELAYED
  CANCELLED
  STUCK
}

enum SecurityEventType {
  FAILED_LOGIN
  BRUTE_FORCE_ATTEMPT
  SUSPICIOUS_IP
  MULTIPLE_DEVICES
  PASSWORD_CHANGED
  EMAIL_CHANGED
  UNUSUAL_ACTIVITY
  API_KEY_LEAKED
  CSRF_ATTEMPT
  XSS_ATTEMPT
  SQL_INJECTION_ATTEMPT
  RATE_LIMIT_EXCEEDED
  INVALID_TOKEN
  UNAUTHORIZED_ACCESS
}

enum SecuritySeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum EventType {
  USER_REGISTERED
  USER_VERIFIED
  TEST_COMPLETED
  SUBSCRIPTION_CREATED
  SUBSCRIPTION_CANCELLED
  PAYMENT_SUCCEEDED
  PAYMENT_FAILED
  QUESTION_REPORTED
  ACHIEVEMENT_UNLOCKED
  DAILY_CHALLENGE_COMPLETED
  STREAK_MILESTONE
}

enum DeliveryStatus {
  PENDING
  DELIVERED
  FAILED
  RETRYING
}
